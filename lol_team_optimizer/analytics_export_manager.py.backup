"""
Analytics Export Manager for comprehensive data export and reporting.

This module provides functionality to export analytics data in multiple formats
and generate comprehensive reports with customizable templates.
"""

import json
import csv
import io
import logging
from datetime import datetime, timedelta
from pathlib import Path
from typing import Dict, List, Optional, Any, Union
from dataclasses import dataclass, asdict
from enum import Enum
import threading
import schedule
import time

try:
    import pandas as pd
    PANDAS_AVAILABLE = True
except ImportError:
    PANDAS_AVAILABLE = False

try:
    from reportlab.lib.pagesizes import letter, A4
    from reportlab.platypus import SimpleDocTemplate, Paragraph, Spacer, Table, TableStyle
    from reportlab.lib.styles import getSampleStyleSheet, ParagraphStyle
    from reportlab.lib.units import inch
    from reportlab.lib import colors
    REPORTLAB_AVAILABLE = True
except ImportError:
    REPORTLAB_AVAILABLE = False

from .analytics_models import (
    PlayerAnalytics, ChampionPerformanceMetrics, TeamComposition,
    CompositionPerformance, ChampionRecommendation, PerformanceDelta,
    AnalyticsFilters, TrendAnalysis, ComparativeAnalysis
)


class ExportFormat(Enum):
    """Supported export formats."""
    CSV = "csv"
    JSON = "json"
    EXCEL = "xlsx"
    PDF = "pdf"


class ReportType(Enum):
    """Types of reports that can be generated."""
    PLAYER_PERFORMANCE = "player_performance"
    CHAMPION_ANALYSIS = "champion_analysis"
    TEAM_COMPOSITION = "team_composition"
    COMPARATIVE_ANALYSIS = "comparative_analysis"
    TREND_ANALYSIS = "trend_analysis"
    COMPREHENSIVE = "comprehensive"


@dataclass
class ExportConfiguration:
    """Configuration for data export operations."""
    format: ExportFormat
    include_metadata: bool = True
    include_raw_data: bool = False
    date_format: str = "%Y-%m-%d %H:%M:%S"
    decimal_places: int = 3
    custom_fields: Optional[List[str]] = None


@dataclass
class ReportTemplate:
    """Template configuration for report generation."""
    name: str
    report_type: ReportType
    title: str
    description: str
    sections: List[str]
    metrics: List[str]
    visualizations: List[str]
    custom_styling: Optional[Dict[str, Any]] = None


@dataclass
class ReportSchedule:
    """Configuration for scheduled report generation."""
    name: str
    template: ReportTemplate
    frequency: str  # daily, weekly, monthly
    recipients: List[str]
    export_formats: List[ExportFormat]
    filters: Optional[AnalyticsFilters] = None
    enabled: bool = True


class AnalyticsExportManager:
    """
    Comprehensive export and reporting manager for analytics data.
    
    Provides functionality to export analytics data in multiple formats,
    generate customizable reports, and manage scheduled reporting.
    """
    
    def __init__(self, output_directory: Path):
        """
        Initialize the export manager.
        
        Args:
            output_directory: Directory for storing exported files and reports
        """
        self.output_directory = Path(output_directory)
        self.output_directory.mkdir(parents=True, exist_ok=True)
        
        self.logger = logging.getLogger(__name__)
        self.templates: Dict[str, ReportTemplate] = {}
        self.schedules: Dict[str, ReportSchedule] = {}
        self.scheduler_thread: Optional[threading.Thread] = None
        self.scheduler_running = False
        
        # Initialize default templates
        self._initialize_default_templates()
        
        # Check for optional dependencies
        if not PANDAS_AVAILABLE:
            self.logger.warning("Pandas not available - Excel export will be limited")
        if not REPORTLAB_AVAILABLE:
            self.logger.warning("ReportLab not available - PDF export will be disabled")
    
    def _initialize_default_templates(self):
        """Initialize default report templates."""
        # Player Performance Template
        self.templates["player_performance"] = ReportTemplate(
            name="player_performance",
            report_type=ReportType.PLAYER_PERFORMANCE,
            title="Player Performance Analysis",
            description="Comprehensive analysis of individual player performance",
            sections=["summary", "performance_metrics", "champion_analysis", "trends"],
            metrics=["win_rate", "kda", "cs_per_min", "vision_score", "damage_per_min"],
            visualizations=["performance_chart", "trend_graph", "champion_breakdown"]
        )
        
        # Champion Analysis Template
        self.templates["champion_analysis"] = ReportTemplate(
            name="champion_analysis",
            report_type=ReportType.CHAMPION_ANALYSIS,
            title="Champion Performance Analysis",
            description="Detailed analysis of champion performance and recommendations",
            sections=["champion_overview", "performance_comparison", "recommendations"],
            metrics=["win_rate", "pick_rate", "performance_delta", "synergy_score"],
            visualizations=["champion_comparison", "recommendation_chart"]
        )
        
        # Team Composition Template
        self.templates["team_composition"] = ReportTemplate(
            name="team_composition",
            report_type=ReportType.TEAM_COMPOSITION,
            title="Team Composition Analysis",
            description="Analysis of team compositions and synergy effects",
            sections=["composition_overview", "synergy_analysis", "optimal_compositions"],
            metrics=["composition_win_rate", "synergy_effects", "performance_deltas"],
            visualizations=["synergy_matrix", "composition_comparison"]
        )
    
    def export_player_analytics(
        self,
        analytics: PlayerAnalytics,
        format: ExportFormat,
        config: Optional[ExportConfiguration] = None
    ) -> Path:
        """
        Export player analytics data in the specified format.
        
        Args:
            analytics: Player analytics data to export
            format: Export format
            config: Export configuration options
            
        Returns:
            Path to the exported file
        """
        if config is None:
            config = ExportConfiguration(format=format)
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"player_analytics_{analytics.puuid}_{timestamp}.{format.value}"
        filepath = self.output_directory / filename
        
        try:
            if format == ExportFormat.JSON:
                self._export_to_json(analytics, filepath, config)
            elif format == ExportFormat.CSV:
                self._export_player_to_csv(analytics, filepath, config)
            elif format == ExportFormat.EXCEL:
                self._export_player_to_excel(analytics, filepath, config)
            elif format == ExportFormat.PDF:
                self._export_player_to_pdf(analytics, filepath, config)
            else:
                raise ValueError(f"Unsupported export format: {format}")
            
            self.logger.info(f"Exported player analytics to {filepath}")
            return filepath
            
        except Exception as e:
            self.logger.error(f"Failed to export player analytics: {e}")
            raise
    
    def export_champion_analytics(
        self,
        champion_data: List[ChampionPerformanceMetrics],
        format: ExportFormat,
        config: Optional[ExportConfiguration] = None
    ) -> Path:
        """
        Export champion analytics data in the specified format.
        
        Args:
            champion_data: Champion performance data to export
            format: Export format
            config: Export configuration options
            
        Returns:
            Path to the exported file
        """
        if config is None:
            config = ExportConfiguration(format=format)
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"champion_analytics_{timestamp}.{format.value}"
        filepath = self.output_directory / filename
        
        try:
            if format == ExportFormat.JSON:
                self._export_to_json(champion_data, filepath, config)
            elif format == ExportFormat.CSV:
                self._export_champion_to_csv(champion_data, filepath, config)
            elif format == ExportFormat.EXCEL:
                self._export_champion_to_excel(champion_data, filepath, config)
            elif format == ExportFormat.PDF:
                self._export_champion_to_pdf(champion_data, filepath, config)
            else:
                raise ValueError(f"Unsupported export format: {format}")
            
            self.logger.info(f"Exported champion analytics to {filepath}")
            return filepath
            
        except Exception as e:
            self.logger.error(f"Failed to export champion analytics: {e}")
            raise
    
    def export_team_composition_analytics(
        self,
        composition_data: List[CompositionPerformance],
        format: ExportFormat,
        config: Optional[ExportConfiguration] = None
    ) -> Path:
        """
        Export team composition analytics data in the specified format.
        
        Args:
            composition_data: Team composition performance data to export
            format: Export format
            config: Export configuration options
            
        Returns:
            Path to the exported file
        """
        if config is None:
            config = ExportConfiguration(format=format)
        
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"team_composition_analytics_{timestamp}.{format.value}"
        filepath = self.output_directory / filename
        
        try:
            if format == ExportFormat.JSON:
                self._export_to_json(composition_data, filepath, config)
            elif format == ExportFormat.CSV:
                self._export_composition_to_csv(composition_data, filepath, config)
            elif format == ExportFormat.EXCEL:
                self._export_composition_to_excel(composition_data, filepath, config)
            elif format == ExportFormat.PDF:
                self._export_composition_to_pdf(composition_data, filepath, config)
            else:
                raise ValueError(f"Unsupported export format: {format}")
            
            self.logger.info(f"Exported team composition analytics to {filepath}")
            return filepath
            
        except Exception as e:
            self.logger.error(f"Failed to export team composition analytics: {e}")
            raise
    
    def _export_to_json(self, data: Any, filepath: Path, config: ExportConfiguration):
        """Export data to JSON format."""
        export_data = {
            "metadata": {
                "export_timestamp": datetime.now().strftime(config.date_format),
                "format": "json",
                "version": "1.0"
            } if config.include_metadata else {},
            "data": self._serialize_for_json(data)
        }
        
        with open(filepath, 'w', encoding='utf-8') as f:
            json.dump(export_data, f, indent=2, ensure_ascii=False, default=str)
    
    def _serialize_for_json(self, obj: Any) -> Any:
        """Serialize objects for JSON export."""
        if hasattr(obj, '__dict__'):
            return asdict(obj) if hasattr(obj, '__dataclass_fields__') else obj.__dict__
        elif isinstance(obj, list):
            return [self._serialize_for_json(item) for item in obj]
        elif isinstance(obj, dict):
            return {k: self._serialize_for_json(v) for k, v in obj.items()}
        else:
            return obj
    
    def _export_player_to_csv(self, analytics: PlayerAnalytics, filepath: Path, config: ExportConfiguration):
        """Export player analytics to CSV format."""
        with open(filepath, 'w', newline='', encoding='utf-8') as csvfile:
            writer = csv.writer(csvfile)
            
            # Write metadata if requested
            if config.include_metadata:
                writer.writerow(["# Player Analytics Export"])
                writer.writerow(["# Export Date:", datetime.now().strftime(config.date_format)])
                writer.writerow(["# Player PUUID:", analytics.puuid])
                writer.writerow([])
            
            # Write overall performance
            writer.writerow(["Overall Performance"])
            writer.writerow(["Metric", "Value"])
            if analytics.overall_performance:
                perf = analytics.overall_performance
                writer.writerow(["Win Rate", f"{perf.win_rate:.{config.decimal_places}f}"])
                writer.writerow(["Average KDA", f"{perf.avg_kda:.{config.decimal_places}f}"])
                writer.writerow(["CS per Minute", f"{perf.avg_cs_per_min:.{config.decimal_places}f}"])
                writer.writerow(["Vision Score", f"{perf.avg_vision_score:.{config.decimal_places}f}"])
                writer.writerow(["Damage per Minute", f"{perf.avg_damage_per_min:.{config.decimal_places}f}"])
            
            writer.writerow([])
            
            # Write champion performance
            if analytics.champion_performance:
                writer.writerow(["Champion Performance"])
                writer.writerow([
                    "Champion", "Role", "Games", "Win Rate", "KDA", 
                    "CS/min", "Vision Score", "Damage/min"
                ])
                
                for champion_id, champion_data in analytics.champion_performance.items():
                    writer.writerow([
                        champion_data.champion_name,
                        champion_data.role,
                        champion_data.games_played,
                        f"{champion_data.win_rate:.{config.decimal_places}f}",
                        f"{champion_data.avg_kda:.{config.decimal_places}f}",
                        f"{champion_data.avg_cs_per_min:.{config.decimal_places}f}",
                        f"{champion_data.avg_vision_score:.{config.decimal_places}f}",
                        f"{champion_data.avg_damage_per_min:.{config.decimal_places}f}"
                    ])